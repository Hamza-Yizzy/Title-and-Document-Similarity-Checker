{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book List - Similarity Checker</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-400 via-purple-400 to-indigo-500 min-h-screen text-gray-800">

<!-- Logout Icon -->
<a href="{% url 'logout' %}" class="absolute top-5 left-5 text-white text-xl">
  <i class="fas fa-sign-out-alt"></i>
</a>

<div class="container bg-white mt-24 mb-12 rounded-xl shadow-lg py-6 px-8 mx-auto">
  <h1 class="text-3xl font-bold text-center mb-6">📚 Book List</h1>

  <!-- Search and Selector -->
  <div class="d-flex justify-content-between mb-3">
    <input type="text" id="searchInput" class="form-control w-50" placeholder="🔍 Search by title...">
    <select id="rowSelector" class="form-select w-25">
      <option value="5">Show 5</option>
      <option value="10" selected>Show 10</option>
      <option value="25">Show 25</option>
    </select>
  </div>

  <!-- Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-dark text-center">
        <tr>
          <th>Title</th>
          <th>Authors</th>
          <th>Area</th>
          <th>Year</th>
          <th>File</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="bookTable">
        {% for book in books %}
        <tr>
          <td class="book-title">{{ book.book_title }}</td>
          <td>{{ book.authors }}</td>
          <td>{{ book.area }}</td>
          <td>{{ book.year }}</td>
          <td>
            {% if book.file %}
              <a href="{% url 'view_book_file' book.book_id %}" target="_blank" class="text-info"><i class="fa fa-eye"></i> View</a>
            {% else %}
              <span class="text-muted">No File</span>
            {% endif %}
          </td>
          <td class="text-center">
            <a href="{% url 'edit_book' book.book_id %}" class="btn btn-success btn-sm me-2">
              <i class="fa fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-sm delete-btn" data-book-id="{{ book.book_id }}">
              <i class="fa fa-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center text-muted">No books available. Add a new book!</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  <div class="d-flex justify-content-between align-items-center mt-4">
    <a href="{% url 'add_book' %}" class="btn btn-success"><i class="fa fa-plus"></i> Add New Book</a>
    <div class="d-flex gap-2">
      <button id="prevBtn" class="btn btn-outline-dark">Previous</button>
      <button id="nextBtn" class="btn btn-outline-dark">Next</button>
    </div>
    <a href="{% url 'dashboard' %}" class="btn btn-primary"><i class="fa fa-home"></i> Back to Dashboard</a>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg text-center relative w-96">
    <button class="absolute top-2 right-3 text-gray-600 text-lg close">&times;</button>
    <h4 class="text-lg font-semibold mb-4">Are you sure you want to delete this book?</h4>
    <form id="deleteForm" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger me-3">Yes, Delete</button>
      <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
    </form>
  </div>
</div>

<!-- JS -->
<script>
  const rows = document.querySelectorAll('#bookTable tr');
  let currentPage = 1;
  const rowSelector = document.getElementById('rowSelector');

  function paginate() {
    const maxRows = parseInt(rowSelector.value);
    const start = (currentPage - 1) * maxRows;
    const end = start + maxRows;

    rows.forEach((row, i) => {
      if (!row.classList.contains('hidden-search')) {
        row.style.display = (i >= start && i < end) ? '' : 'none';
      } else {
        row.style.display = 'none';
      }
    });

    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= rows.length;
  }

  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentPage > 1) currentPage--;
    paginate();
  });

  document.getElementById('nextBtn').addEventListener('click', () => {
    const maxRows = parseInt(rowSelector.value);
    if (currentPage * maxRows < rows.length) currentPage++;
    paginate();
  });

  rowSelector.addEventListener('change', () => {
    currentPage = 1;
    paginate();
  });

  document.getElementById('searchInput').addEventListener('input', function () {
    const query = this.value.toLowerCase();

    rows.forEach(row => {
      const titleCell = row.querySelector('.book-title');
      if (!titleCell) return;

      const titleText = titleCell.textContent.trim().toLowerCase();

      if (titleText.startsWith(query)) {
        row.classList.remove('hidden-search');
      } else {
        row.classList.add('hidden-search');
      }
    });

    currentPage = 1;
    paginate();
  });

  // Delete Modal
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const bookId = btn.getAttribute('data-book-id');
      const formAction = '{% url "delete_book" 0 %}'.replace('0', bookId);
      document.getElementById('deleteForm').action = formAction;
      document.getElementById('confirmModal').classList.remove('hidden');
      document.getElementById('confirmModal').classList.add('flex');
    });
  });

  document.querySelector('.cancel-btn').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.add('hidden');
  });

  document.querySelector('.close').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.add('hidden');
  });

  // Initial paginate call
  paginate();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

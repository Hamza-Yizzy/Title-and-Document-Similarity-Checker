{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Registered Users{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

<div class="max-w-6xl mx-auto mt-6" x-data="userImport()">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
      <!-- ðŸ‘¥ Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-4-4h-1m-6 6H2v-2a4 4 0 014-4h1m6-2a4 4 0 100-8 4 4 0 000 8zM6 10a4 4 0 110-8 4 4 0 010 8z" />
      </svg>
      Registered Users
    </h1>

    <div class="flex gap-2">
      <!-- Import Users Button -->
      <button @click="showImportModal = true" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-semibold flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Import Users
      </button>

      <a href="{% url 'dashboard' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded shadow transition gap-1">
        <!-- ðŸ”™ Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Table Section with Search, Pagination, and Rows Per Page -->
  <div class="modal-content" style="padding: 20px 24px;">
    <div class="modal-header pr-2.5 mb-4 border-b pb-2">
      <div class="flex justify-between items-center w-full">
        <h3 class="modal-title font-semibold text-lg">User List</h3>
        <div class="flex gap-3">
          <input type="text" x-model.debounce="searchQuery" placeholder="Search..." class="form-control w-full max-w-xs text-sm px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400">
          <select x-model="rowsPerPage" class="form-select text-sm px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-400 focus:border-blue-400">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
      <table class="min-w-full bg-white rounded-lg shadow">
        <thead class="bg-blue-600 text-white sticky top-0">
          <tr>
            <th class="py-3 px-6 text-left">Username</th>
            <th class="py-3 px-6 text-left">Email</th>
            <th class="py-3 px-6 text-left">Role</th>
            <th class="py-3 px-6 text-left">Date Joined</th>
            <th class="py-3 px-6 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="user in filteredUsers" :key="user.id">
            <tr class="border-b hover:bg-gray-50">
              <td class="py-3 px-6 flex items-center gap-2">
                <template x-if="user.is_superuser || user.groups.includes('Admin')">
                  <!-- âœ… Blue Round Check Icon beside name -->
                  <span x-text="user.username"></span>
                  <span class="inline-block bg-blue-500 text-white rounded-full p-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                    </svg>
                  </span>
                </template>
                <template x-if="!(user.is_superuser || user.groups.includes('Admin'))">
                  <span x-text="user.username"></span>
                </template>
              </td>
              <td class="py-3 px-6" x-text="user.email"></td>
              <td class="py-3 px-6">
                <template x-if="user.is_superuser || user.groups.includes('Admin')">
                  <span class="text-green-600 font-semibold">Admin</span>
                </template>
                <template x-if="user.groups.includes('Supervisor')">
                  <span class="text-red-600 font-semibold">Supervisor</span>
                </template>
                <template x-if="!(user.is_superuser || user.groups.includes('Admin') || user.groups.includes('Supervisor'))">
                  <span class="text-blue-600 font-semibold">Student</span>
                </template>
              </td>
              <td class="py-3 px-6" x-text="user.date_joined"></td>
              <td class="py-3 px-6 flex gap-2">
                <!-- Edit -->
                <a :href="'{% url 'edit_user' 0 %}'.replace('0', user.id)" class="inline-flex items-center px-3 py-1.5 text-sm text-white bg-yellow-500 hover:bg-yellow-600 rounded transition gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-5m-5.586-7.414a2 2 0 112.828 2.828L11 16l-4 1 1-4 8.586-8.586z" />
                  </svg>
                  Edit
                </a>

                <!-- Delete -->
                <form :id="'delete-form-' + user.id" method="post" :action="'{% url 'delete_user' 0 %}'.replace('0', user.id)">
                  {% csrf_token %}
                  <button type="button" @click="showConfirm = true; formId = 'delete-form-' + user.id" class="inline-flex items-center px-3 py-1.5 text-sm text-white bg-red-600 hover:bg-red-700 rounded transition gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4m-4 0a1 1 0 00-1 1v1h6V4a1 1 0 00-1-1m-4 0h4" />
                    </svg>
                    Delete
                  </button>
                </form>
              </td>
            </tr>
          </template>
          <template x-if="filteredUsers.length === 0">
            <tr>
              <td colspan="5" class="text-center py-4 text-gray-500">No users found.</td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="modal-footer flex justify-between pt-3 items-center">
      <div class="flex gap-2">
        <button @click="previousPage" :disabled="currentPage === 1" class="btn btn-secondary">Previous</button>
        <button @click="nextPage" :disabled="currentPage * rowsPerPage >= totalUsers" class="btn btn-secondary">Next</button>
      </div>
      <span class="text-sm text-gray-600">Page <span x-text="currentPage"></span> of <span x-text="Math.ceil(totalUsers / rowsPerPage)"></span></span>
    </div>
  </div>

  <!-- ðŸ§¾ Confirmation Modal -->
  <div
    x-show="showConfirm"
    x-transition
    class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-white border border-gray-300 rounded-lg shadow-xl p-4 w-full max-w-md z-50"
  >
    <div class="flex items-center justify-between">
      <p class="text-sm text-gray-800 font-medium">
        Are you sure you want to delete this user?
      </p>
      <div class="flex gap-2">
        <button @click="showConfirm = false" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm">Cancel</button>
        <button @click="document.getElementById(formId).submit()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- ðŸ—‚ï¸ Import Modal -->
  <div
    x-show="showImportModal"
    x-transition
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
  >
    <div class="bg-white w-full max-w-md p-6 rounded-lg shadow-xl">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Import Users
      </h2>

      <form id="importForm" enctype="multipart/form-data" action="{% url 'import_users_api' %}" method="post">
        {% csrf_token %}
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Upload Excel File</label>
          <input type="file" name="file" id="fileUpload" accept=".xls,.xlsx" required
                 class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-400 focus:border-blue-400 text-sm px-3 py-2">
        </div>

        <div class="mb-4">
          <a href="{% static 'sample_users_template.xlsx' %}" download class="text-blue-600 underline text-sm">ðŸ“¥ Download Sample Excel Format</a>
        </div>

        <div class="flex justify-end gap-2">
          <button type="button" @click="showImportModal = false" class="px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 rounded">Cancel</button>
          <button type="button" @click="previewFile()" class="px-3 py-1.5 text-sm bg-yellow-500 hover:bg-yellow-600 text-white rounded">Preview</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ðŸ‘ï¸ Preview Modal -->
  <div
    x-show="showPreviewModal"
    x-transition
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
  >
    <div class="bg-white w-full max-w-lg p-6 rounded-lg shadow-xl">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">ðŸ§¾ Preview & Validate</h2>

      <div id="previewContainer" class="text-sm text-gray-600 mb-4">
        <template x-if="previewData">
          <table class="min-w-full bg-white">
            <thead>
              <tr>
                <th class="py-2 px-4">Username</th>
                <th class="py-2 px-4">Email</th>
                <th class="py-2 px-4">Role</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="user in previewData" :key="user.username">
                <tr>
                  <td class="py-2 px-4" x-text="user.username"></td>
                  <td class="py-2 px-4" x-text="user.email"></td>
                  <td class="py-2 px-4" x-text="user.role"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </template>
        <template x-if="!previewData">
          <p class="italic">Select a file to preview.</p>
        </template>
      </div>

      <div class="flex justify-end gap-2">
        <button @click="showPreviewModal = false" class="px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 rounded">Back</button>
        <button type="button" @click="uploadFile()" class="px-3 py-1.5 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded">Upload</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('userImport', () => ({
      showConfirm: false,
      deleteUrl: '',
      formId: '',
      showImportModal: false,
      showPreviewModal: false,
      previewData: null,
      users: {{ users_json|safe }}, // Use the serialized JSON data
      searchQuery: '',
      currentPage: 1,
      rowsPerPage: 5,
      totalUsers: {{ users|length }}, // Total number of users

      // Computed property for filtered and paginated users
      get filteredUsers() {
        let filtered = this.users.filter(user => 
          user.username.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
          user.email.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
          (user.role && user.role.toLowerCase().includes(this.searchQuery.toLowerCase()))
        );
        const start = (this.currentPage - 1) * this.rowsPerPage;
        const end = start + this.rowsPerPage;
        return filtered.slice(start, end);
      },

      // Pagination methods
      previousPage() {
        if (this.currentPage > 1) this.currentPage--;
      },
      nextPage() {
        if (this.currentPage * this.rowsPerPage < this.totalUsers) this.currentPage++;
      },

      async previewFile() {
        const form = document.getElementById('importForm');
        const formData = new FormData(form);
        try {
          const response = await fetch("{% url 'preview_user_import' %}", {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          });
          const result = await response.json();
          if (result.status === 'ok') {
            this.previewData = result.data;
            this.showPreviewModal = true;
          } else {
            alert(result.message);
            this.showPreviewModal = false;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to preview file.');
          this.showPreviewModal = false;
        }
      },

      async uploadFile() {
        const form = document.getElementById('importForm');
        const formData = new FormData(form);
        try {
          const response = await fetch("{% url 'import_users_api' %}", {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': '{{ csrf_token }}'
            }
          });
          const result = await response.json();
          if (result.status) {
            alert(`Imported: ${result.imported.join(', ') || 'None'}\nSkipped: ${result.skipped.join(', ') || 'None'}`);
            this.showPreviewModal = false;
            this.showImportModal = false;
            window.location.reload(); // Refresh to show new users
          } else {
            alert(result.message);
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to upload file.');
        }
      }
    }));
  });
</script>
{% endblock %}